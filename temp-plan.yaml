version: 3.0.0
metadata:
  title: UserProfile Domain Layer - Clean Architecture
  description: TDD template for user profile feature following the master template rules.
  source: TODO_DOMAIN_TEMPLATE.yaml
  lastUpdated: 2025-01-16
structure:
  basePath: src/features/user-profile/domain
  folders:
    - errors
    - use-cases
    - test
layer_rules:
  can_import_from_domain:
    - Data Layer - Implements the use case interfaces
    - Presentation Layer - Uses domain types and calls use cases
    - Infrastructure Layer - May use domain types for adapters
    - Main/Factory Layer - Wires everything together, knows all layers
    - Test Files - Can import domain types and interfaces for testing
  cannot_import_from_domain:
    - External Libraries - Should never know about domain
    - Node Modules - Third-party code should not depend on domain
  domain_cannot_import_from:
    - Any other layer - Domain must be completely independent
    - Data Layer - No implementation details
    - Presentation Layer - No UI concerns
    - Infrastructure Layer - No external dependencies
    - Main Layer - No dependency injection logic
    - External Libraries - No third-party dependencies
domain_rules:
  allowed:
    - Simple type definitions (Input/Output types)
    - Use case interfaces (contracts only)
    - Domain-specific error classes
    - Test mock functions
  forbidden:
    - Framework dependencies (React, Next.js, Express)
    - External libraries (axios, fetch, database clients)
    - Implementation details of any kind
    - UI components
    - HTTP/Database/File system operations
    - Environment variables
    - Console.log or any I/O operations
    - Value objects
    - Entities
    - Business rules or business logic
    - Validation logic
    - Calculations or computations
    - Any behavior beyond type definitions and interfaces
use_case_rules:
  should:
    - Define only interfaces/contracts, not implementations
    - Have EXACTLY ONE responsibility (one business operation)
    - Do ONE thing and ONE thing only (never multiple operations)
    - Return domain types or primitives
    - Be named with verbs (CreateUser, AuthenticateUser, etc.)
    - Be framework agnostic
  should_not:
    - Contain implementation logic
    - Know about HTTP, databases, or external services
    - Import from data, presentation, or infrastructure layers
    - Have side effects
    - Execute multiple operations (e.g., CreateUserAndSendEmail is wrong)
error_rules:
  should:
    - Extend the native Error class
    - Have descriptive names ending with Error
    - Contain meaningful error messages
    - Represent business rule violations
    - Be thrown when domain invariants are violated
  should_not:
    - Contain HTTP status codes
    - Include technical/implementation details
    - Expose sensitive information
    - Import external dependencies
test_helper_rules:
  should:
    - Create mock/stub implementations of use cases
    - Generate fake test data
    - Be pure functions that return consistent data
    - Help reduce test boilerplate
    - Use ONLY Vitest (Jest is prohibited)
  should_not:
    - Make real API calls or database queries
    - Depend on external services
    - Contain test assertions (those belong in test files)
    - Have side effects or maintain state
    - Use Jest (use Vitest instead)
steps:
  - id: create-structure
    type: folder
    description: Create domain folder structure
    status: SUCCESS
    rlhf_score: null
    execution_log: |
      Completed successfully at 2025-09-16T11:53:40.302Z.

      --- SCRIPT OUTPUT ---
      ✅ Verifying folder structure...
      ✅ Folders exist.
      📦 Staging changes...
      💾 Creating commit...
      [main 2bf21bd] feat(user-profile): create domain folder structure
       5 files changed, 1347 insertions(+), 1217 deletions(-)
       create mode 100644 .claude/commands/domain-execute.md
       create mode 100644 .logs/temp-plan/execution.log
       create mode 100644 temp-plan.yaml
       delete mode 100644 todo-list-implementation.yaml
       create mode 100644 user-profile-implementation.yaml
      ✅ Successfully committed
    references:
      - type: internal_guideline
        source: ARCHITECTURE.md
        description: Following the standard feature-based domain structure.
    action:
      create_folders:
        basePath: src/features/user-profile/domain
        folders:
          - errors
          - use-cases
          - test
    validation_script: >
      echo "✅ Verifying folder structure..."

      # Adiciona uma verificação explícita para falhar se as pastas não
      existirem

      if [ ! -d "src/features/user-profile/domain/errors" ] || \
         [ ! -d "src/features/user-profile/domain/use-cases" ] || \
         [ ! -d "src/features/user-profile/domain/test" ]; then
        echo "❌ ERROR: One or more domain folders were not created."
        exit 1
      fi

      echo "✅ Folders exist."


      echo "📦 Staging changes..."

      git add .


      echo "💾 Creating commit..."

      git commit -m "feat(user-profile): create domain folder structure"

      if [ $? -ne 0 ]; then
        echo "❌ COMMIT FAILED - Checking git status..."
        git status
        echo "📋 Review the status above and fix any issues"
        exit 1
      fi

      echo "✅ Successfully committed"
  - id: create-use-case-get-user-profile
    type: create_file
    description: Create GetUserProfile use case interface
    status: SUCCESS
    rlhf_score: null
    execution_log: |
      Completed successfully at 2025-09-16T11:53:41.965Z.

      --- SCRIPT OUTPUT ---
      🔍 Running lint check...
      yarn run v1.22.22
      warning ../../package.json: No license field
      $ eslint .

      /Users/thiagobutignon/dev/spec-kit-clean-archicteture/coverage/block-navigation.js
        1:1  warning  Unused eslint-disable directive (no problems were reported)

      ✖ 1 problem (0 errors, 1 warning)
        0 errors and 1 warning potentially fixable with the `--fix` option.

      Done in 0.94s.
      ✅ Lint passed
      🧪 Running tests with coverage...
      yarn run v1.22.22
      warning ../../package.json: No license field
      $ vitest --passWithNoTests --coverage

       RUN  v3.2.4 /Users/thiagobutignon/dev/spec-kit-clean-archicteture
            Coverage enabled with v8

      No test files found, exiting with code 0

      include: **/*.{test,spec}.?(c|m)[jt]s?(x)
      exclude:  **/node_modules/**, **/dist/**, **/cypress/**, **/.{idea,git,cache,output,temp}/**, **/{karma,rollup,webpack,vite,vitest,jest,ava,babel,nyc,cypress,tsup,build,eslint,prettier}.config.*

       % Coverage report from v8
      -------------------|---------|----------|---------|---------|-------------------
      File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
      -------------------|---------|----------|---------|---------|-------------------
      All files          |       0 |       75 |      75 |       0 |                   
       ...n-archicteture |       0 |    66.66 |   66.66 |       0 |                   
        execute-steps.ts |       0 |      100 |     100 |       0 | 3-265             
        logger.ts        |       0 |        0 |       0 |       0 | 1-46              
        ...ementation.ts |       0 |      100 |     100 |       0 | 3-293             
       ...main/use-cases |       0 |        0 |       0 |       0 |                   
        ...er-profile.ts |       0 |        0 |       0 |       0 |                   
      -------------------|---------|----------|---------|---------|-------------------
      Done in 0.49s.
      ✅ Tests passed
      📦 Staging changes...
      💾 Creating commit...
      [main 876e4f8] feat(user-profile): add get-user-profile use case
       23 files changed, 1363 insertions(+), 2508 deletions(-)
       rename coverage/spec-kit-clean-archicteture/{src/features/todo-list/domain/test/mock-list-todos-use-case.ts.html => logger.ts.html} (59%)
       delete mode 100644 coverage/spec-kit-clean-archicteture/src/features/todo-list/domain/errors/index.html
       delete mode 100644 coverage/spec-kit-clean-archicteture/src/features/todo-list/domain/errors/invalid-todo-data.ts.html
       delete mode 100644 coverage/spec-kit-clean-archicteture/src/features/todo-list/domain/errors/todo-not-found.ts.html
       delete mode 100644 coverage/spec-kit-clean-archicteture/src/features/todo-list/domain/errors/unauthorized-tenant-access.ts.html
       delete mode 100644 coverage/spec-kit-clean-archicteture/src/features/todo-list/domain/test/index.html
       delete mode 100644 coverage/spec-kit-clean-archicteture/src/features/todo-list/domain/test/mock-create-todo-use-case.ts.html
       delete mode 100644 coverage/spec-kit-clean-archicteture/src/features/todo-list/domain/test/mock-delete-todo-use-case.ts.html
       delete mode 100644 coverage/spec-kit-clean-archicteture/src/features/todo-list/domain/test/mock-update-todo-use-case.ts.html
       delete mode 100644 coverage/spec-kit-clean-archicteture/src/features/todo-list/domain/use-cases/create-todo.ts.html
       delete mode 100644 coverage/spec-kit-clean-archicteture/src/features/todo-list/domain/use-cases/list-todos.ts.html
       delete mode 100644 coverage/spec-kit-clean-archicteture/src/features/todo-list/domain/use-cases/update-todo.ts.html
       rename coverage/spec-kit-clean-archicteture/src/features/{todo-list/domain/use-cases/delete-todo.ts.html => user-profile/domain/use-cases/get-user-profile.ts.html} (86%)
       rename coverage/spec-kit-clean-archicteture/src/features/{todo-list => user-profile}/domain/use-cases/index.html (64%)
       create mode 100644 src/features/user-profile/domain/use-cases/get-user-profile.ts
      ✅ Successfully committed
    references:
      - type: external_pattern
        source: context7
        query: awesome system design user profile retrieval
        url: https://github.com/donnemartin/system-design-primer
        description: This use case follows the Command pattern for handling actions.
      - type: internal_code_analysis
        source: serena
        tool: find_symbol
        query: "*UseCase"
        description: The structure is consistent with existing use cases like
          `OtherUseCase` found in the project.
    path: src/features/user-profile/domain/use-cases/get-user-profile.ts
    template: |
      /**
       * Input parameters for GetUserProfileUseCase
       */
      export type GetUserProfileInput = {
        userId: string
      }

      /**
       * Output type for GetUserProfileUseCase
       */
      export type GetUserProfileOutput = {
        id: string
        email: string
        firstName: string
        lastName: string
      }

      /**
       * GetUserProfileUseCase interface
       * @description Retrieves a user's profile information
       */
      export interface GetUserProfileUseCase {
        /**
         * Execute the get user profile operation
         * @param input - The input parameters
         * @returns Promise with the operation output
         */
        execute: (input: GetUserProfileInput) => Promise<GetUserProfileOutput>
      }
    validation_script: >
      # AI-NOTE: This script is immutable. Only the commit message placeholder
      is replaced.

      echo "🔍 Running lint check..."

      yarn lint

      if [ $? -ne 0 ]; then
        echo "❌ LINT FAILED - Attempting auto-fix..."
        yarn lint --fix
        if [ $? -ne 0 ]; then
          echo "❌ AUTO-FIX FAILED - Manual intervention required"
          echo "📋 Run 'yarn lint' to see remaining errors"
          exit 1
        fi
        echo "✅ Lint errors auto-fixed, validating again..."
        yarn lint
        if [ $? -ne 0 ]; then
          echo "❌ LINT STILL FAILING - Manual fixes needed"
          exit 1
        fi
      fi

      echo "✅ Lint passed"


      echo "🧪 Running tests with coverage..."

      yarn test --coverage

      if [ $? -ne 0 ]; then
        echo "❌ TESTS FAILED - Running specific test to identify issue..."
        yarn test --run --reporter=verbose
        echo "❌ Tests must be fixed manually"
        echo "📋 Check the test output above for details"
        exit 1
      fi

      echo "✅ Tests passed"


      echo "📦 Staging changes..."

      git add .


      echo "💾 Creating commit..."

      git commit -m "feat(user-profile): add get-user-profile use case"

      if [ $? -ne 0 ]; then
        echo "❌ COMMIT FAILED - Checking git status..."
        git status
        echo "📋 Review the status above and fix any issues"
        exit 1
      fi

      echo "✅ Successfully committed"
  - id: create-error-user-not-found
    type: create_file
    description: Create user-not-found domain error
    status: PENDING
    rlhf_score: null
    execution_log: ""
    references:
      - type: external_pattern
        source: context7
        query: awesome system design error handling
        url: https://github.com/goldbergyoni/nodebestpractices
        description: This error follows best practices for domain error handling.
      - type: internal_code_analysis
        source: serena
        tool: find_symbol
        query: "*Error"
        description: The structure is consistent with existing error classes found in
          the project.
    path: src/features/user-profile/domain/errors/user-not-found.ts
    template: |
      /**
       * Error thrown when the requested user does not exist
       * @extends Error
       */
      export class UserNotFoundError extends Error {
        constructor() {
          super('User with the given ID was not found')
          this.name = 'UserNotFoundError'
        }
      }
    validation_script: |
      echo "🔍 Running lint check..."
      yarn lint
      if [ $? -ne 0 ]; then
        echo "❌ LINT FAILED - Attempting auto-fix..."
        yarn lint --fix
        if [ $? -ne 0 ]; then
          echo "❌ AUTO-FIX FAILED - Manual intervention required"
          echo "📋 Run 'yarn lint' to see remaining errors"
          exit 1
        fi
        echo "✅ Lint errors auto-fixed, validating again..."
        yarn lint
        if [ $? -ne 0 ]; then
          echo "❌ LINT STILL FAILING - Manual fixes needed"
          exit 1
        fi
      fi
      echo "✅ Lint passed"

      echo "🧪 Running tests with coverage..."
      yarn test --coverage
      if [ $? -ne 0 ]; then
        echo "❌ TESTS FAILED - Running specific test to identify issue..."
        yarn test --run --reporter=verbose
        echo "❌ Tests must be fixed manually"
        echo "📋 Check the test output above for details"
        exit 1
      fi
      echo "✅ Tests passed"

      echo "📦 Staging changes..."
      git add .

      echo "💾 Creating commit..."
      git commit -m "feat(user-profile): add user-not-found domain error"
      if [ $? -ne 0 ]; then
        echo "❌ COMMIT FAILED - Checking git status..."
        git status
        echo "📋 Review the status above and fix any issues"
        exit 1
      fi
      echo "✅ Successfully committed"
  - id: create-test-helper-get-user-profile
    type: create_file
    description: Create mock for GetUserProfile use case
    status: PENDING
    rlhf_score: null
    execution_log: ""
    references:
      - type: external_pattern
        source: context7
        query: vitest testing best practices
        url: https://vitest.dev/guide/mocking
        description: Following Vitest best practices for creating test mocks.
      - type: internal_code_analysis
        source: serena
        tool: find_symbol
        query: mock*UseCase
        description: The structure is consistent with existing test helpers found in the
          project.
    path: src/features/user-profile/domain/test/mock-get-user-profile-use-case.ts
    template: >
      import { vi } from 'vitest'

      import type { GetUserProfileUseCase, GetUserProfileInput,
      GetUserProfileOutput } from '../use-cases/get-user-profile'


      /**
       * Creates a mock instance of GetUserProfileInput
       * @returns Mock input for testing
       */
      export const mockGetUserProfileInput = (): GetUserProfileInput => ({
        userId: 'user-123'
      })


      /**
       * Creates a mock instance of GetUserProfileOutput
       * @returns Mock output for testing
       */
      export const mockGetUserProfileOutput = (): GetUserProfileOutput => ({
        id: 'user-123',
        email: 'test@example.com',
        firstName: 'John',
        lastName: 'Doe'
      })


      /**
       * Creates a mock instance of GetUserProfileUseCase
       * @returns Mocked use case with vitest functions
       */
      export const mockGetUserProfileUseCase = (): GetUserProfileUseCase => ({
        execute: vi.fn()
      })
    validation_script: >
      echo "🔍 Running lint check..."

      yarn lint

      if [ $? -ne 0 ]; then
        echo "❌ LINT FAILED - Attempting auto-fix..."
        yarn lint --fix
        if [ $? -ne 0 ]; then
          echo "❌ AUTO-FIX FAILED - Manual intervention required"
          echo "📋 Run 'yarn lint' to see remaining errors"
          exit 1
        fi
        echo "✅ Lint errors auto-fixed, validating again..."
        yarn lint
        if [ $? -ne 0 ]; then
          echo "❌ LINT STILL FAILING - Manual fixes needed"
          exit 1
        fi
      fi

      echo "✅ Lint passed"


      echo "🧪 Running tests with coverage..."

      yarn test --coverage

      if [ $? -ne 0 ]; then
        echo "❌ TESTS FAILED - Running specific test to identify issue..."
        yarn test --run --reporter=verbose
        echo "❌ Tests must be fixed manually"
        echo "📋 Check the test output above for details"
        exit 1
      fi

      echo "✅ Tests passed"


      echo "📦 Staging changes..."

      git add .


      echo "💾 Creating commit..."

      git commit -m "test(user-profile): add get-user-profile use case test
      helpers"

      if [ $? -ne 0 ]; then
        echo "❌ COMMIT FAILED - Checking git status..."
        git status
        echo "📋 Review the status above and fix any issues"
        exit 1
      fi

      echo "✅ Successfully committed"
troubleshooting:
  lint_fails:
    - DO NOT commit - Fix all lint errors first
    - Check for unused imports
    - Verify proper TypeScript types
    - Ensure no console.log statements
    - Run yarn lint --fix to auto-fix when possible
  tests_fail:
    - DO NOT commit - All tests must pass
    - Check if mocks match the actual interfaces
    - Verify Input/Output types are correct
    - Ensure test coverage meets requirements
    - "Run specific test: yarn test [test-file-path]"
  typescript_fails:
    - Check all type definitions match
    - Ensure no missing imports
    - Verify interface implementations are complete
    - Run yarn tsc --noEmit to check types
refactoring:
  before_refactoring: |
    # Check current status and differences
    echo "📊 Checking current changes..."
    git status
    git diff

    # Ensure clean working directory
    echo "✅ Saving current work..."
    git stash save "WIP: before refactoring"

    # Create refactoring branch
    echo "🌿 Creating refactor branch..."
    git checkout -b refactor/[feature-name]

    # Run tests to ensure starting point is stable
    echo "🧪 Validating current state..."
    yarn test --run
    if [ $? -ne 0 ]; then
      echo "❌ Tests failing before refactor - fix first!"
      exit 1
    fi
    echo "✅ Ready to refactor"
  during_refactoring: |
    # After each change, check what was modified
    echo "🔍 Reviewing changes..."
    git diff --stat
    git diff

    # Validate the change
    yarn lint && yarn test --run

    # Commit atomically
    git add -p  # Interactive staging to commit only related changes
    git commit -m "refactor([feature-name]): [specific change description]"

    # Show what was changed in the last commit
    git show --stat
  common_scenarios:
    - name: Splitting a use case
      wrong_example: >
        interface CreateUserAndSendEmailUseCase {
          execute: (input: CreateUserAndSendEmailInput) => Promise<CreateUserAndSendEmailOutput>
        }
      correct_example: >
        interface CreateUserUseCase {
          execute: (input: CreateUserInput) => Promise<CreateUserOutput>
        }

        interface SendWelcomeEmailUseCase {
          execute: (input: SendWelcomeEmailInput) => Promise<SendWelcomeEmailOutput>
        }
      script: |
        # Split the combined use case into separate files
        # Update all imports and references
        # Run tests after each change
    - name: Renaming for clarity
      script: >
        # 1. See all occurrences before changing

        echo "🔍 Finding all occurrences of [OldName]..."

        grep -r "[OldName]" src/features/[feature-name]/


        # 2. Perform the rename

        echo "✏️ Renaming [OldName] to [NewName]..."

        # Update files...


        # 3. Review the changes

        echo "📊 Reviewing rename changes..."

        git diff --word-diff


        # 4. Validate nothing broke

        yarn lint && yarn test --run


        # 5. Check if rename is complete

        echo "🔍 Ensuring no [OldName] remains..."

        grep -r "[OldName]" src/features/[feature-name]/

        if [ $? -eq 0 ]; then
          echo "⚠️ Warning: [OldName] still found in some files"
        fi


        # 6. Commit the rename

        git add .

        git commit -m "refactor([feature-name]): rename [OldName] to [NewName]
        for clarity"


        # 7. Show the final diff

        git show --stat
recovery:
  accidental_commit: |
    # Revert the last commit but keep changes
    git reset --soft HEAD~1

    # Fix the issues
    # ... make corrections ...

    # Re-run validation
    yarn lint
    yarn test --coverage

    # Commit again with fixed code
    git add .
    git commit -m "[original message] - fixed"
  domain_polluted: >
    # 1. Identify violations in domain

    echo "🔍 Checking for domain violations..."

    git diff src/features/[feature-name]/domain/


    # Check for forbidden patterns

    echo "⚠️ Checking for business logic..."

    grep -r "class.*{.*calculate\|validate\|process"
    src/features/[feature-name]/domain/


    echo "⚠️ Checking for external dependencies..."

    grep -r "import.*axios\|fetch\|http" src/features/[feature-name]/domain/


    echo "⚠️ Checking for console logs..."

    grep -r "console\." src/features/[feature-name]/domain/


    # 2. Show what needs to be moved

    git diff src/features/[feature-name]/domain/ --name-only


    # 3. After moving code to proper layers

    echo "✅ Validating domain is clean..."

    yarn lint

    yarn test --run


    # 4. Commit the cleanup

    git add .

    git diff --staged --stat

    git commit -m "refactor([feature-name]): remove business logic from domain
    layer"
ai_guidelines:
  - "Always validate before committing: Run lint first, Run tests second, Only
    commit if both pass"
  - "If generation fails: Identify the specific error, Fix only that error,
    Re-run validation, Do NOT proceed until fixed"
  - "Follow the principle: One use case = One file = One responsibility"
  - If tempted to add "And" in a use case name, split it
  - "When in doubt: Choose simplicity over complexity, Split rather than
    combine, Ask for clarification rather than assume"
  - 'MUST generate different case styles from the input names (e.g., "Add Item
    To Cart" becomes: PascalCase=AddItemToCart, kebab-case=add-item-to-cart,
    lower case=add item to cart).'
  - MUST replace ALL placeholder variables (like __FEATURE_NAME_KEBAB_CASE__)
    with actual values
  - MUST NOT leave any placeholder variables in the final implementation
  - MUST NOT replace any [placeholders] found inside documentation sections like
    refactoring or recovery
  - MUST use vitest, NOT jest
  - MUST follow all domain rules - no business logic, no external dependencies
evaluation:
  final_status: PENDING
  final_rlhf_score: null
  reviewer_summary: |
    - What went well:
      - ...
    - Areas for improvement:
      - ...
  template_improvement_suggestions:
    - target_template: domain.template.yaml
      target_step_id: create-use-case-get-user-profile
      suggestion: The generated mock data was too simplistic. The template should be
        updated to include more realistic data generation.
      priority: medium
